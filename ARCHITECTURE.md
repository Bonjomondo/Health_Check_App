# Smart Health Guard - 系统架构文档

## 系统概览

```
┌─────────────────────────────────────────────────────────────┐
│                    Android App (客户端)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  监测页面     │  │  历史页面     │  │  设置页面     │      │
│  │  (Main)      │  │  (History)   │  │  (Settings)  │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
│         │                 │                 │              │
│         └─────────────────┼─────────────────┘              │
│                           │                                │
│                    ┌──────▼───────┐                        │
│                    │  MqttManager │                        │
│                    └──────┬───────┘                        │
└───────────────────────────┼────────────────────────────────┘
                            │ MQTT Protocol
                            │
                    ┌───────▼────────┐
                    │  阿里云 IoT     │
                    │  (Broker)      │
                    └───────┬────────┘
                            │ MQTT Protocol
                            │
┌───────────────────────────▼────────────────────────────────┐
│                    单片机系统 (MCU)                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ MAX30102 │  │ DS18B20  │  │   DHT    │  │ MPU6050  │  │
│  │ 心率/血氧 │  │   体温    │  │  温湿度   │  │  运动    │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
│                                                            │
│         ┌──────────┐              ┌──────────┐            │
│         │  蜂鸣器   │              │  电池     │            │
│         │  (报警)   │              │  (电量)   │            │
│         └──────────┘              └──────────┘            │
└────────────────────────────────────────────────────────────┘
```

## MQTT 主题结构

### 订阅主题 (App → 云 ← MCU)

#### sensor/data
接收传感器数据
```json
{
  "heartRate": 75,
  "bloodOxygen": 98,
  "bodyTemperature": 36.5,
  "environmentTemperature": 25.0,
  "humidity": 60,
  "motionStatus": "SEDENTARY",
  "steps": 1234,
  "battery": 85,
  "timestamp": 1637500000000
}
```

#### device/status
接收设备状态
```json
{
  "battery": 85,
  "charging": false,
  "timestamp": 1637500000000
}
```

### 发布主题 (App → 云 → MCU)

#### device/command
发送控制指令
```json
{
  "command": "START_MEASURE",
  "timestamp": 1637500000000
}
```

支持的命令：
- `START_MEASURE` - 开始测量
- `ALARM_FALL` - 跌倒报警
- `ALARM_FEVER` - 高烧报警
- `ALARM_HEART_RATE` - 心率异常报警

## 数据流图

### 正常监测流程

```
1. 用户点击"开始测量"按钮
   │
   ▼
2. App发送 START_MEASURE 命令
   │
   ▼
3. MCU接收命令，启动MAX30102采集
   │
   ▼
4. MCU采集数据并通过MQTT发送
   │
   ▼
5. App接收数据并更新UI (每500ms-1s)
   │
   ▼
6. App检查阈值
   │
   ├─ 正常 → 显示绿色状态
   │
   └─ 异常 → 弹窗 + 震动 + 发送报警命令给MCU
              │
              ▼
           MCU触发蜂鸣器
```

### 跌倒检测流程

```
1. MPU6050检测到加速度异常
   │
   ▼
2. MCU判定为跌倒，发送状态
   │
   ▼
3. App接收到 motionStatus: "FALL_DETECTED"
   │
   ▼
4. App弹出警报对话框
   │
   ▼
5. App震动提醒
   │
   ▼
6. App发送 ALARM_FALL 命令
   │
   ▼
7. MCU触发蜂鸣器报警
```

## 页面交互流程

### 页面一：实时监测
```
┌─────────────────────────────────────┐
│     顶部栏                           │
│  [Smart Health Guard] [●连接] [85%] │
├─────────────────────────────────────┤
│     ❤️                               │
│     75 BPM                          │
│     正常                             │
├─────────────┬───────────────────────┤
│  💧         │  🌡️                   │
│  98 %       │  36.5 °C             │
├─────────────┴───────────────────────┤
│  环境                                │
│  25°C         60%                   │
├─────────────────────────────────────┤
│  运动状态                            │
│  静止 - 1234步                       │
└─────────────────────────────────────┘
             [▶ 开始测量]
     [监测] [历史] [设置]
```

### 页面二：历史趋势
```
┌─────────────────────────────────────┐
│  [心率] [血氧] [体温]                │
├─────────────────────────────────────┤
│  ○ 1小时  ● 24小时                   │
├─────────────────────────────────────┤
│         折线图                        │
│    ╱╲    ╱╲                         │
│   ╱  ╲  ╱  ╲                        │
│  ╱    ╲╱    ╲                       │
├─────────────────────────────────────┤
│  异常记录                            │
│  [10:23] 心率 - 心率过高: 120 BPM    │
│  [09:15] 体温 - 体温异常: 38.2°C     │
└─────────────────────────────────────┘
```

### 页面三：设置
```
┌─────────────────────────────────────┐
│  连接管理                            │
│  [扫描设备]                          │
│  [Wi-Fi配置]                         │
├─────────────────────────────────────┤
│  阈值设置                            │
│  心率上限: 100 BPM [━━●━━━━]        │
│  体温上限: 37.3°C  [━━●━━━━]        │
├─────────────────────────────────────┤
│  功能开关                            │
│  久坐提醒      [ ○ ]                │
│  震动反馈      [ ● ]                │
└─────────────────────────────────────┘
```

## 技术栈

### Android App
- **语言**: Java
- **最低SDK**: Android 7.0 (API 24)
- **目标SDK**: Android 14 (API 36)
- **UI框架**: Material Design Components
- **图表库**: MPAndroidChart 3.1.0
- **MQTT库**: Eclipse Paho MQTT 1.2.5
- **架构模式**: MVC

### 单片机系统
- **传感器**:
  - MAX30102: I2C, 心率/血氧
  - DS18B20: 1-Wire, 体温
  - DHT11/DHT22: 单总线, 温湿度
  - MPU6050: I2C, 加速度/陀螺仪
- **通信**: MQTT via ESP8266/ESP32
- **报警**: 蜂鸣器
- **电源**: 锂电池 + 充电管理

## 性能优化

1. **UI刷新限流**: 500ms-1s刷新一次，避免频繁更新导致卡顿
2. **MQTT QoS**: 使用QoS 1保证消息至少送达一次
3. **自动重连**: MQTT断线自动重连机制
4. **数据缓存**: SharedPreferences缓存设置，避免频繁读写
5. **异步处理**: MQTT回调在工作线程，UI更新切换到主线程

## 安全考虑

1. **认证**: MQTT连接使用用户名/密码认证
2. **加密**: 建议使用TLS加密MQTT连接 (tcp → ssl)
3. **权限**: 运行时请求蓝牙和位置权限
4. **数据验证**: JSON解析异常处理，防止崩溃

## 部署清单

- [ ] 配置阿里云IoT实例
- [ ] 创建设备和Topic
- [ ] 在App中配置MQTT连接信息
- [ ] 烧录单片机程序
- [ ] 测试MQTT连接
- [ ] 测试传感器数据传输
- [ ] 测试报警功能
- [ ] 调整阈值参数
- [ ] 打包APK并安装
